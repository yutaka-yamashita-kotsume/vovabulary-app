<div class="max-w-2xl mx-auto px-4 py-12 text-center">
  
  <div class="mb-6">
    <span class="px-4 py-2 bg-slate-100 text-slate-600 rounded-full text-sm font-bold">
      Question <%= @current_index %> / <%= @total_questions %>
    </span>
  </div>

  <div class="bg-white rounded-3xl p-10 shadow-xl border border-slate-100 mb-8">
    <p class="text-sm text-indigo-500 font-bold tracking-widest uppercase mb-2">ã“ã®å˜èªã®æ„å‘³ã¯ï¼Ÿ</p>
    
    <%# å˜èªè¡¨ç¤ºéƒ¨åˆ† %>
    <h2 id="question-text" class="text-5xl font-extrabold text-slate-800 mb-10">
      <%= @correct_word.original_text %>
    </h2>
<div class="flex justify-center gap-1 mb-6">
  <span class="text-xs text-slate-400 mr-2">Current Status:</span>
  <% @correct_word.consecutive_correct_count.times do %>
    <span class="text-xl">ğŸ”¥</span>
  <% end %>
  <% (3 - @correct_word.consecutive_correct_count).times do %>
    <span class="text-xl text-slate-200">â—‹</span>
  <% end %>
</div>

    <div class="grid grid-cols-1 gap-4">
      <% @choices.each do |choice| %>
        <button onclick="checkAnswer(this, '<%= choice == @correct_word %>')" 
                class="choice-btn w-full py-4 px-6 text-lg font-semibold rounded-2xl border-2 border-slate-100 hover:border-indigo-500 hover:bg-indigo-50 transition-all duration-200 text-slate-700">
          <%= choice.meaning %>
        </button>
      <% end %>
    </div>
  </div>

  <%= link_to "ä¸€è¦§ã«æˆ»ã‚‹", root_path, class: "text-slate-400 text-sm" %>
</div>

<script>
  // éŸ³å£°å†ç”Ÿ
  function speak(text) {
    if (!text) return;
    window.speechSynthesis.cancel();
    const uttr = new SpeechSynthesisUtterance(text);
    uttr.lang = 'en-US';
    uttr.rate = 0.9;
    window.speechSynthesis.speak(uttr);
  }

  // 1. ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å†ç”Ÿã‚’è©¦ã¿ã‚‹
  document.addEventListener("turbo:load", () => {
    const questionText = document.getElementById("question-text");
    if (questionText) {
      setTimeout(() => speak(questionText.innerText.trim()), 500);
    }
  });

  // 2. éŸ³å£°ãƒ–ãƒ­ãƒƒã‚¯å¯¾ç­–ï¼šç”»é¢ã®ã©ã“ã‹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰éŸ³ãŒå‡ºã‚‹ã‚ˆã†ã«ã™ã‚‹
  document.addEventListener("click", () => {
    const questionText = document.getElementById("question-text");
    // ã¾ã éŸ³ãŒé³´ã£ã¦ã„ãªã„å ´åˆã ã‘é³´ã‚‰ã™
    if (!window.speechSynthesis.speaking) {
      speak(questionText?.innerText.trim());
    }
  }, { once: true }); // æœ€åˆã®1å›ã ã‘å®Ÿè¡Œ

  async function checkAnswer(button, isCorrectStr) {
    const isCorrect = (isCorrectStr === "true");
    const buttons = document.querySelectorAll('.choice-btn');
    buttons.forEach(btn => btn.disabled = true);

    // è¦‹ãŸç›®ã®å¤‰åŒ–ï¼ˆã“ã‚Œã‚’å…ˆã«ã‚„ã‚‹ã“ã¨ã§ä½“æ„Ÿé€Ÿåº¦ã‚’ä¸Šã’ã¾ã™ï¼‰
    if (isCorrect) {
      button.style.backgroundColor = "#22c55e";
      button.style.color = "white";
    } else {
      button.style.backgroundColor = "#ef4444";
      button.style.color = "white";
    }

    try {
      const response = await fetch("/quiz/record_answer", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
          word_id: "<%= @correct_word.id %>",
          correct: isCorrect
        })
      });

      if (response.status === 404) {
        console.error("ã‚¨ãƒ©ãƒ¼: ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚routes.rbã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
    } catch (e) {
      console.error("è¨˜éŒ²å¤±æ•—:", e);
    }
    
    setTimeout(() => {
      window.location.href = "<%= quiz_path %>";
    }, 1000);
  }
</script>